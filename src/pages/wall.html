<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Wall of Tomorrow</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="../../src/css/styles.css" rel="stylesheet"/>
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png"/>
    <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png"/>
    <link rel="manifest" href="/assets/images/site.webmanifest"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ecb613",
                        "background-light": "#f8f8f6",
                        "background-dark": "#221d10",
                        "surface-dark": "#2c2616",
                        "surface-light": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
        
        /* --- MOVIE CREDITS ANIMATION (Post-2026) --- */
        .credits-mask {
            position: relative;
            height: 100%;
            overflow: hidden;
        }

        .credits-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5rem;
            padding-bottom: 50vh;
            will-change: transform;
        }

        .credits-mask:hover .credits-content {
            animation-play-state: paused;
        }
        
        /* --- MINIMALIST GRID (Pre-2026) --- */
        .minimal-card {
            border: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-white antialiased overflow-hidden selection:bg-primary/30">
<div class="relative flex h-screen w-full flex-col">
    <!-- TopAppBar -->
    <header class="absolute top-0 z-50 flex items-center justify-between w-full px-5 py-4 bg-background-dark pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-3">
            <h2 class="text-xl font-medium tracking-tight text-white/50">Wall of Tomorrow</h2>
        </div>
        <a href="/src/pages/index.html" class="pointer-events-auto flex items-center justify-center rounded-full w-10 h-10 hover:bg-white/5 transition-colors">
            <span class="material-symbols-outlined text-white/50">arrow_back</span>
        </a>
    </header>
    
    <!-- Main Content Container -->
    <main id="mainContainer" class="flex-1 w-full h-full relative px-4 pt-24 pb-24 overflow-y-auto no-scrollbar">
        <!-- Content injected by JS based on date -->
        <div class="text-center w-full py-20">
            <div class="w-6 h-6 border border-primary border-t-transparent rounded-full animate-spin mx-auto"></div>
        </div>
    </main>
    
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 bg-background-dark px-6 py-4">
        <div class="flex items-center justify-around max-w-md mx-auto gap-8">
            <a href="/src/pages/index.html" class="flex flex-col items-center gap-1 opacity-40 hover:opacity-100 transition-opacity">
                <span class="material-symbols-outlined text-white text-[24px]">home</span>
                <span class="text-[9px] uppercase tracking-widest text-white">Home</span>
            </a>
            <a href="/src/pages/index.html#landing" class="flex flex-col items-center gap-1 opacity-40 hover:opacity-100 transition-opacity">
                <span class="material-symbols-outlined text-white text-[24px]">edit_note</span>
                <span class="text-[9px] uppercase tracking-widest text-white">Write</span>
            </a>
            <button class="flex flex-col items-center gap-1">
                <span class="material-symbols-outlined text-primary text-[24px]">grid_view</span>
                <span class="text-[9px] uppercase tracking-widest text-primary">Wall</span>
            </button>
        </div>
    </nav>
</div>

<script src="../../src/js/api.js"></script>
<script src="../../src/js/app.js"></script>
<script src="../../src/js/fireworks.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initial gentle rain
        fireworks.init({ autoRain: false }); 
        
        // Load wishes will determine the show mode
        loadPublicWishes();
    });

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function loadPublicWishes() {
        const container = document.getElementById('mainContainer');
        const now = new Date();
        const isFuture = now.getFullYear() >= 2026;

        // Hide "Write" option in nav immediately if future
        if (isFuture) {
            const writeLink = document.querySelector('a[href*="#landing"]');
            if (writeLink) writeLink.style.display = 'none';
        }
        
        try {
            // Fetch ALL wishes (limit set to 10000)
            const response = await wishAPI.getWishes(true, 10000);
            if (!response.success) throw new Error(response.message);
            
            let publicWishes = response.data;

            container.innerHTML = '';

            // --- MODE 1: FUTURE (Movie Credits) ---
            if (isFuture) {
                // Remove padding/overflow from main container for full-screen effect
                container.classList.remove('px-4', 'pt-20', 'pb-24', 'overflow-y-auto');
                container.classList.add('overflow-hidden');
                
                // Start the Grand Show
                fireworks.startContinuousShow();

                publicWishes = shuffleArray(publicWishes);
                renderCreditsView(container, publicWishes);
            } 
            // --- MODE 2: PRESENT (Minimalist Grid) ---
            else {
                // Gentle background rain
                fireworks.startRain();
                
                // Optional opening celebration with DRONES
                setTimeout(() => {
                    fireworks.celebrateSequence(5, 500, true);
                }, 500);

                renderGridView(container, publicWishes);
            }

        } catch (error) {
            console.error('Error loading wishes:', error);
            container.innerHTML = '<div class="flex h-full items-center justify-center"><p class="text-red-400">Failed to load wishes.</p></div>';
        }
    }

    /**
     * Renders the Minimalist Grid View (Pre-2026)
     */
    function renderGridView(container, wishes) {
        // ... (Header logic same as before) ...
        // Header
        const header = document.createElement('div');
        header.className = 'flex flex-col items-center justify-center py-8 text-center mb-8';
        header.innerHTML = `
            <span class="material-symbols-outlined text-white/20 mb-4 text-3xl">nights_stay</span>
            <h1 class="text-3xl md:text-4xl font-light text-white mb-2">Wishes for Tomorrow</h1>
            <p class="text-white/40 text-sm tracking-widest uppercase">Waiting for 2026</p>
        `;
        container.appendChild(header);

        if (wishes.length === 0) {
            container.innerHTML += '<p class="text-center text-white/30 italic mt-12">Be the first to wish...</p>';
            return;
        }

        // Grid Container
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mx-auto w-full max-w-6xl pb-24';

        wishes.forEach((wish, index) => {
            const card = document.createElement('div');
            // Minimalist card style
            card.className = 'minimal-card bg-transparent border border-white/5 p-8 rounded-xl flex flex-col justify-between min-h-[200px]';
            card.innerHTML = `
                <p class="text-xl md:text-2xl text-white/80 font-serif italic leading-relaxed">"${wish.text}"</p>
                <div class="mt-6 flex items-center gap-3 opacity-40">
                    <span class="w-8 h-[1px] bg-white"></span>
                    <p class="text-xs uppercase tracking-widest">${app.getTimeAgo(wish.createdAt)}</p>
                </div>
            `;
            grid.appendChild(card);
        });

        container.appendChild(grid);
    }

    /**
     * Renders the Movie Credits View (Post-2026)
     */
    function renderCreditsView(container, wishes) {
        // ... (Credits structure) ...
        const mask = document.createElement('div');
        mask.id = 'creditsContainer';
        mask.className = 'credits-mask w-full h-full flex justify-center';
        
        // Changed to let so it can be updated
        let content = document.createElement('div');
        content.id = 'creditsContent';
        content.className = 'credits-content';
        
        // 1. Title
        const titleDiv = document.createElement('div');
        titleDiv.className = 'text-center px-4 max-w-2xl w-full';
        titleDiv.innerHTML = `
            <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight">The Hopes of Yesterday</h1>
            <div class="w-12 h-[1px] bg-primary mx-auto mb-6"></div>
            <p class="text-primary/80 uppercase tracking-[0.4em] text-xs md:text-sm">Manifested Today</p>
        `;
        content.appendChild(titleDiv);

        if (wishes.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'text-white/40 italic';
            empty.textContent = 'The story is yet to be written...';
            content.appendChild(empty);
            // Stop show immediately if no wishes
             setTimeout(() => fireworks.stopShow(), 5000);
        } else {
            // 2. Wishes List
            wishes.forEach((wish) => {
                const el = document.createElement('div');
                el.className = 'text-center px-6 max-w-3xl w-full group';
                el.innerHTML = `
                    <p class="text-2xl md:text-4xl text-white/90 font-serif italic font-light leading-relaxed mb-4 group-hover:text-primary transition-colors duration-500">
                        "${wish.text}"
                    </p>
                    <div class="flex items-center justify-center gap-2 text-xs text-white/30 uppercase tracking-[0.2em]">
                        <span>${app.getTimeAgo(wish.createdAt)}</span>
                        <span class="w-1 h-1 bg-primary rounded-full"></span>
                        <span>2025</span>
                    </div>
                `;
                content.appendChild(el);
            });
        }

        // 3. Footer
        const endDiv = document.createElement('div');
        endDiv.className = 'text-center mt-24 mb-40 opacity-40';
        endDiv.innerHTML = `
            <span class="material-symbols-outlined text-4xl mb-4">auto_awesome</span>
            <p class="text-xs uppercase tracking-widest">One Minute for Tomorrow</p>
        `;
        content.appendChild(endDiv);

        mask.appendChild(content);
        container.appendChild(mask);

        // Setup Animation (WAAPI)
        // Wait a tick for DOM to render to calculate height
        requestAnimationFrame(() => {
            setupAnimation(content, wishes.length);
        });
        
        // Stop show when animation ends -> NOW LOOP
        content.addEventListener('animationend', function handleEnd(e) {
             console.log('Credits finished. Restarting.');
             
             const oldContent = e.target;
             // Ensure we are replacing a valid child
             if (oldContent.parentNode !== mask) return;

             // To restart CSS animation, we can clone the node
             const newContent = oldContent.cloneNode(true);
             mask.replaceChild(newContent, oldContent);
             
             // Re-attach listener
             newContent.addEventListener('animationend', handleEnd);
             
             // Re-apply animation
             requestAnimationFrame(() => {
                 setupAnimation(newContent, wishes.length);
             });
             
             // Update reference
             content = newContent;
        });
    }

    function setupAnimation(element, itemCount) {
        // Run ONCE to satisfy "stop when all wishes displayed"
        // Speed up by 15x (divide duration by 15)
        const duration = Math.max(25, 10 + (itemCount * 4)) / 15; 
        element.style.animation = `crawl ${duration}s linear 1 forwards`;
    }
</script>
<!-- Inject Keyframes dynamically -->
<style>
    @keyframes crawl {
        from { transform: translateY(100vh); }
        to { transform: translateY(-100%); }
    }
</style>
</body>
</html>
