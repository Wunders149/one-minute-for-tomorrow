<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Writing Screen - One Minute for Tomorrow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="../../src/css/styles.css" rel="stylesheet"/>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }

        :root {
            --primary: #ecb613;
            --background-dark: #221d10;
            --input-focus-glow: 0 0 15px rgba(236, 182, 19, 0.3);
        }

        .dark {
            color-scheme: dark;
        }

        /* Enhanced text input focus effect */
        #wishInput:focus {
            box-shadow: var(--input-focus-glow);
        }

        /* Subtle typing animation */
        @keyframes type-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .typing-animation {
            animation: type-pulse 2s ease-in-out infinite;
        }

        /* Character count progress bar */
        .char-count-bar {
            height: 2px;
            background: rgba(236, 182, 19, 0.1);
            border-radius: 1px;
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .char-count-bar::after {
            content: '';
            display: block;
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--primary));
            width: var(--bar-width, 0%);
            transition: width 0.2s ease, background-color 0.3s ease;
            border-radius: 1px;
        }

        .char-count-bar.warning::after {
            background: linear-gradient(to right, #fbbf24, #fbbf24);
        }

        .char-count-bar.critical::after {
            background: linear-gradient(to right, #f87171, #f87171);
        }

        /* Progress indicator for text input */
        .text-progress {
            position: relative;
        }

        .text-progress::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 0%;
            background: linear-gradient(to right, transparent, var(--primary));
            transition: width 0.3s ease;
        }

        .text-progress.full::after {
            width: 100%;
        }

        /* Enhanced timer animation for urgency */
        .urgent-timer {
            animation: urgent-pulse 1s infinite;
        }

        @keyframes urgent-pulse {
            0% { text-shadow: 0 0 5px rgba(236, 182, 19, 0.5); }
            50% { text-shadow: 0 0 20px rgba(236, 182, 19, 0.8), 0 0 30px rgba(236, 182, 19, 0.6); }
            100% { text-shadow: 0 0 5px rgba(236, 182, 19, 0.5); }
        }

        /* Enhanced character counter feedback */
        .char-count-normal {
            color: #94a3b8; /* text-slate-400 */
        }

        .char-count-warning {
            color: #fbbf24; /* text-amber-400 */
            animation: pulse 1.5s infinite;
        }

        .char-count-critical {
            color: #f87171; /* text-red-400 */
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Improved typography and spacing */
        .writing-container {
            max-width: 28rem; /* Optimized width for focused writing */
            width: 100%;
        }

        .input-container {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        #wishInput {
            font-size: 1.25rem; /* text-lg */
            line-height: 1.75; /* leading-7 for better readability */
            letter-spacing: -0.01em; /* Slightly tighter letter spacing for better readability */
            transition: color 0.2s ease;
        }

        #wishInput::placeholder {
            opacity: 0.5;
        }

        @media (min-width: 768px) {
            #wishInput {
                font-size: 1.5rem; /* text-xl */
                line-height: 1.75; /* leading-7 */
            }
        }

        .timer-container {
            padding-top: 1.5rem;
            padding-bottom: 1rem;
        }

        .timer-display {
            font-size: 2.5rem; /* text-3xl */
            line-height: 1.2;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .timer-label {
            font-size: 0.625rem; /* text-xs */
            letter-spacing: 0.2em;
        }

        .action-bar {
            padding-top: 1.25rem;
            padding-bottom: 1.25rem;
        }

        .char-count-container {
            padding-top: 0.125rem; /* pt-0.5 */
        }

        /* Visual focus cues */
        .input-container {
            position: relative;
            background: radial-gradient(ellipse at center, rgba(236, 182, 19, 0.02) 0%, transparent 70%);
            transition: background 0.3s ease;
        }

        .input-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid rgba(236, 182, 19, 0.1); /* border-primary/10 */
            pointer-events: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-container:focus-within::before {
            border-color: rgba(236, 182, 19, 0.5); /* border-primary/50 */
            box-shadow: 0 0 20px rgba(236, 182, 19, 0.15), inset 0 0 20px rgba(236, 182, 19, 0.05);
        }

        /* Subtle background glow when focused */
        .input-container:focus-within {
            background: radial-gradient(ellipse at center, rgba(236, 182, 19, 0.08) 0%, transparent 70%);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .writing-container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .input-container {
                padding-top: 1.5rem;
                padding-bottom: 1.5rem;
            }

            #wishInput {
                font-size: 1.125rem; /* text-base */
                line-height: 1.75; /* leading-7 */
            }

            .timer-display {
                font-size: 2rem; /* text-2xl */
            }

            .action-bar {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .writing-container {
                max-width: 32rem; /* Optimized width for larger screens */
            }

            #wishInput {
                font-size: 1.75rem; /* text-2xl */
                line-height: 1.75; /* leading-7 */
            }

            .timer-display {
                font-size: 3rem; /* text-4xl */
            }
        }

        /* Enhanced button styling */
        .submit-btn {
            position: relative;
            overflow: hidden;
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .submit-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .submit-btn:hover {
            transform: translateY(-1px);
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        /* Accessibility improvements */
        .submit-btn:focus-visible {
            outline: 2px solid rgba(236, 182, 19, 0.6);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display antialiased h-screen w-full flex flex-col relative selection:bg-primary/30 selection:text-white">
    <!-- Gradient Overlay for Midnight Vibe -->
    <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/40 pointer-events-none z-0"></div>

    <!-- Top Bar / Timer -->
    <header class="relative z-10 w-full timer-container flex items-center justify-between px-4">
        <a href="/src/pages/index.html" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-primary/10 transition-all duration-300">
            <span class="material-symbols-outlined text-neutral-900 dark:text-white hover:text-primary">arrow_back</span>
        </a>
        <div class="flex flex-col items-center gap-1">
            <!-- Minimalist Timer -->
            <div class="flex items-baseline gap-1 animate-pulse-slow">
                <span id="timer" class="text-primary timer-display font-light tracking-wider font-mono tabular-nums leading-none drop-shadow-md">01:00</span>
            </div>
            <p class="text-white/40 timer-label uppercase tracking-[0.2em] font-medium">Remaining</p>
        </div>
        <div class="w-10"></div>
    </header>

    <!-- Main Content Area -->
    <main class="relative z-10 flex-1 flex flex-col w-full px-4 writing-container mx-auto">
        <!-- Large Text Input -->
        <div class="flex-1 flex flex-col input-container text-progress">
            <textarea id="wishInput" autofocus class="w-full flex-1 bg-transparent border-none p-0 font-normal leading-relaxed text-white/90 placeholder:text-white/20 focus:ring-0 focus:outline-none resize-none caret-primary typing-animation" placeholder="Write to your future self... What is your one wish for tomorrow?" maxlength="200"></textarea>
            <!-- Character Progress Bar -->
            <div class="char-count-bar" id="charCountBar"></div>
        </div>
        <!-- Action Bar Inside Main Content -->
        <div class="flex items-center justify-between pt-4 pb-2 action-bar">
            <!-- Character Count (MetaText) -->
            <div class="flex items-center gap-2 char-count-container">
                <p id="charCount" class="text-white/30 text-xs font-medium tabular-nums char-count-normal">0/200</p>
            </div>
            <!-- Done Button (FAB style but inline) -->
            <button
                id="submitBtn"
                onclick="submitWish()"
                type="button"
                class="submit-btn flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 transition-all duration-200 text-background-dark rounded-full px-5 py-2 h-10 shadow-[0_0_15px_rgba(236,182,19,0.2)] hover:shadow-[0_0_25px_rgba(236,182,19,0.4)] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-[0_0_15px_rgba(236,182,19,0.2)]"
                aria-label="Submit your wish and continue"
                title="Submit wish (or wait for timer to finish)">
                <span class="material-symbols-outlined text-[20px] font-bold">check</span>
                <span class="text-sm font-bold tracking-wide">Done</span>
            </button>
        </div>
    </main>
</body>

<script src="../../src/js/api.js"></script>
<script src="../../src/js/app.js"></script>
<script>
    const timerElement = document.getElementById('timer');
    const charCountElement = document.getElementById('charCount');
    const charCountBar = document.getElementById('charCountBar');
    const wishInput = document.getElementById('wishInput');
    let timeLeft = 60;
    let isTimerActive = false;

    // Auto-start timer when page loads
    document.addEventListener('DOMContentLoaded', function() {
        wishInput.focus();
        startTimer();
    });

    // Update character count and apply visual feedback
    wishInput.addEventListener('input', function() {
        const currentLength = this.value.length;
        const maxLength = 200;
        const percentage = (currentLength / maxLength) * 100;
        
        charCountElement.textContent = `${currentLength}/${maxLength}`;
        
        // Update progress bar width
        charCountBar.style.setProperty('--bar-width', percentage + '%');

        // Update character counter appearance based on usage
        if (currentLength > maxLength * 0.9) { // More than 90% used
            charCountElement.className = 'text-xs font-medium tabular-nums char-count-critical';
            charCountBar.className = 'char-count-bar critical';
        } else if (currentLength > maxLength * 0.75) { // More than 75% used
            charCountElement.className = 'text-xs font-medium tabular-nums char-count-warning';
            charCountBar.className = 'char-count-bar warning';
        } else {
            charCountElement.className = 'text-xs font-medium tabular-nums char-count-normal';
            charCountBar.className = 'char-count-bar';
        }
    });

    function startTimer() {
        if (isTimerActive) return;
        isTimerActive = true;
        timeLeft = 60;

        const timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Add urgency effect when time is running low (last 10 seconds)
            if (timeLeft <= 10) {
                timerElement.classList.add('urgent-timer');
            } else {
                timerElement.classList.remove('urgent-timer');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                isTimerActive = false;
                submitWish();
            }
        }, 1000);
    }

    function submitWish() {
        const submitBtn = document.getElementById('submitBtn');
        const text = wishInput.value.trim();

        // Validation: Check if text is empty
        if (text.length === 0) {
            wishInput.focus();
            wishInput.classList.add('ring-2', 'ring-red-500');
            setTimeout(() => {
                wishInput.classList.remove('ring-2', 'ring-red-500');
            }, 2000);
            return;
        }

        // Disable button to prevent double submission
        if (submitBtn) {
            submitBtn.disabled = true;
        }

        // Save to backend via API
        wishAPI.createWish(text, false)
            .then(response => {
                if (response.success) {
                    // Store the wish ID in sessionStorage for next page
                    const wish = {
                        id: response.data._id,
                        text: response.data.text,
                        createdAt: response.data.createdAt,
                        isPublic: response.data.isPublic
                    };
                    sessionStorage.setItem('currentWish', JSON.stringify(wish));

                    // Navigate to visibility screen after a brief delay
                    setTimeout(() => {
                        goTo('visibility');
                    }, 300);
                } else {
                    throw new Error(response.message || 'Failed to save wish');
                }
            })
            .catch(error => {
                console.error('Error saving wish:', error);
                alert('There was an error saving your wish. Please try again.');
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            });
    }

    // Prevent accidental navigation if user has unsaved content
    window.addEventListener('beforeunload', function(e) {
        const text = wishInput.value.trim();
        if (text.length > 0 && !sessionStorage.getItem('currentWish')) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>
</html>
